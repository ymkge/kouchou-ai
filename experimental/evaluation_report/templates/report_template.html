<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>{{ result.config.question }}</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        h1,
        h3 {
            color: #2a4365;
        }

        table.stat-table {
            border-collapse: collapse;
            margin-bottom: 20px;
            width: 100%;
            table-layout: fixed;
        }

        table.stat-table th,
        table.stat-table td {
            border: 1px solid #ccc;
            text-align: center;
            padding: 8px;
        }

        table.stat-table th {
            background-color: #f0f8ff;
        }

        table.stat-table td {
            background-color: #f9f9f9;
        }

        .evaluation-block {
            border: 2px solid #ccddee;
            background-color: #f5f9ff;
            padding: 10px 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            display: inline-block;
            width: 200px;
            text-align: center;
            margin: 0 10px;
        }

        .label {
            font-weight: bold;
            font-size: 18px;
        }

        .fullscreen-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 999;
        }

        #groupContainer {
            margin-top: 30px;
        }

        .eval-column {
            display: table-cell;
        }

        .group {
            border: 1px solid #ccc;
            margin: 5px 0;
            padding: 5px 10px;
        }

        .group-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f7f7f7;
            padding: 5px;
        }

        .group-header .toggle {
            font-weight: bold;
            margin-right: 10px;
            user-select: none;
        }

        .group-header .title {
            flex: 1;
        }

        .group-header .stats {
            font-size: 0.9em;
            color: #555;
            margin-left: 10px;
        }

        .group-header .summary {
            font-size: 0.9em;
            color: #333;
            margin-left: 20px;
        }

        .group-children,
        .arguments {
            margin-left: 20px;
            border-left: 1px dashed #ccc;
            padding-left: 10px;
        }

        .argument {
            margin: 5px 0;
            padding: 3px;
            background-color: #eef;
        }

        #toggleAll {
            margin-bottom: 15px;
            background-color: #3182ce;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 1em;
            cursor: pointer;
        }

        #toggleAll:hover {
            background-color: #2a69ac;
        }

        #toggleEvalBtn {
            margin-bottom: 15px;
            background-color: #3182ce;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 1em;
            cursor: pointer;
        }

        #toggleEvalBtn:hover {
            background-color: #2a69ac;
        }

        .score-1 {
            background-color: #fed7d7 !important;
        }

        .score-2 {
            background-color: #fefcbf !important;
        }

        .score-3 {
            background-color: #f0fff4 !important;
        }

        .score-4 {
            background-color: #c6f6d5 !important;
        }

        .score-5 {
            background-color: #9ae6b4 !important;
        }
    </style>
</head>

<body>
    <h1>{{ result.config.question }}</h1>
    <p><strong>{{ result.arguments | length }}ä»¶</strong></p>
    <p>{{ result.overview }}</p>
    <button id="toggleEvalBtn" onclick="toggleEvaluation()">è©•ä¾¡ã‚’éš ã™</button>
    <div id="evaluationBlock" class="evaluation-block">

        <table class="stat-table">
            <tr>
                <th>æ˜ç¢ºã•</th>
                <th>ä¸€è²«æ€§</th>
                <th>æ•´åˆæ€§</th>
                <th>å·®ç•°æ€§</th>
                <th>ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“</th>
                <th>UMAP</th>
            </tr>
            <tr>
                <td class="score-{{ result.llm_avg_scaled.clarity }}">{{ result.llm_avg.clarity }}</td>
                <td class="score-{{ result.llm_avg_scaled.coherence }}">{{ result.llm_avg.coherence }}</td>
                <td class="score-{{ result.llm_avg_scaled.consistency }}">{{ result.llm_avg.consistency }}</td>
                <td class="score-{{ result.llm_avg_scaled.distinctiveness }}">{{ result.llm_avg.distinctiveness }}</td>
                <td class="score-{{ result.llm_avg_scaled.embedding }}">{{ result.llm_avg_scaled.embedding }}ï¼ˆ{{
                    result.silhouette_embedding_avg }}ï¼‰</td>
                <td class="score-{{ result.llm_avg_scaled.umap }}">{{ result.llm_avg_scaled.umap }}ï¼ˆ{{
                    result.silhouette_umap_avg }}ï¼‰</td>
            </tr>
        </table>
        <details class="eval-help" style="margin-top:1.5rem;">
            <summary style="font-weight:bold; cursor:pointer;">ğŸ“Š è©•ä¾¡æŒ‡æ¨™ã®è¦‹æ–¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>
            <div style="padding:0.8rem 1.2rem; line-height:1.6;">
                <h4 style="margin-top:0;">1. å®šæ€§è©•ä¾¡ï¼ˆæ–‡ç« ã®è³ªã‚’ AI ãŒæ¡ç‚¹ï¼‰</h4>
                <ul style="margin-left:1rem;">
                    <li><b>æ˜ç¢ºã• Clarity</b> â€¦ ä¸»èªãƒ»è¿°èªãŒã¯ã£ãã‚Šã—ã¦ã„ã¦ â€œè¨€ã„ãŸã„ã“ã¨â€ ãŒä¼ã‚ã‚‹ã‹</li>
                    <li><b>ä¸€è²«æ€§ Coherence</b> â€¦ æ–‡ã‚„æ®µè½ã®æµã‚ŒãŒè‡ªç„¶ã«ã¤ãªãŒã£ã¦ã„ã‚‹ã‹</li>
                    <li><b>æ•´åˆæ€§ Consistency</b> â€¦ æ„è¦‹ã¨ãã®èª¬æ˜ãƒ»æ ¹æ‹ ã®å†…å®¹ã«çŸ›ç›¾ãŒãªã„ã‹ã€‚åŒã˜ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»–ã®æ„è¦‹ã¨æ¯”ã¹ã¦ã‚‚è‡ªç„¶ãªèª¬æ˜ã«ãªã£ã¦ã„ã‚‹ã‹</li>
                    <li><b>å·®ç•°æ€§ Distinctiveness</b> â€¦ ä»–ã®ã‚¯ãƒ©ã‚¹ã‚¿ã¨è¢«ã‚‰ãªã„ç‹¬è‡ªæ€§ãŒã‚ã‚‹ã‹</li>
                </ul>
                <p>AIï¼ˆLLMï¼‰ãŒ 1ã€œ5 ã®æ•´æ•°ã§æ¡ç‚¹ã—ã¾ã™ã€‚<br>
                    <span style="opacity:0.7;">â€» ã‚ãã¾ã§ç›®å®‰ã§ã™ãŒã€<b>2 ä»¥ä¸‹</b>ã¯æ³¨æ„ä¿¡å· ã¨è€ƒãˆã¦ãã ã•ã„ã€‚</span>
                </p>

                <h4>2. å®šé‡è©•ä¾¡ï¼ˆã¾ã¨ã¾ã‚Šå…·åˆã®ã‚¹ã‚³ã‚¢ï¼‰</h4>
                <p>ã€Œã‚¯ãƒ©ã‚¹ã‚¿å†…ã®å¹³å‡è·é›¢ã€ã¨ã€Œæœ€ã‚‚è¿‘ã„åˆ¥ã‚¯ãƒ©ã‚¹ã‚¿ã¨ã®è·é›¢ã€ã‚’æ¯”è¼ƒã™ã‚‹ <b>ã‚·ãƒ«ã‚¨ãƒƒãƒˆã‚¹ã‚³ã‚¢</b> ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚</p>
                <table
                    style="border-collapse:collapse; font-size:0.9rem;table-layout: fixed; width: 60%; margin-top: 0.3rem;">
                    <thead>
                        <tr>
                            <th style="border-bottom:1px solid #aaa;" colspan="6">ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ï¼ˆEmbeddingï¼‰</th>
                        </tr>
                        <tr>
                            <th style="padding:4px 10px; min-width: 100px;">1</th>
                            <th>2</th>
                            <th>3</th>
                            <th>4</th>
                            <th>5</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            {% for i in range(5) %}
                            {% if i == 0 %}
                            <td>{{ embed_thresholds[i] }} æœªæº€</td>
                            {% elif i == 4 %}
                            <td>{{ embed_thresholds[i-1] }} ä»¥ä¸Š</td>
                            {% else %}
                            <td>{{ embed_thresholds[i-1] }}ï½{{ embed_thresholds[i] }}</td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
                <table
                    style="border-collapse:collapse; font-size:0.9rem; margin-top:0.3rem;table-layout: fixed; width: 60%; ">
                    <thead>
                        <tr>
                            <th style="border-bottom:1px solid #aaa;" colspan="6">å¯è¦–åŒ–ç©ºé–“ï¼ˆUMAPï¼‰</th>
                        </tr>
                        <tr>
                            <th style="padding:2px 6px;">1</th>
                            <th>2</th>
                            <th>3</th>
                            <th>4</th>
                            <th>5</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            {% for i in range(5) %}
                            {% if i == 0 %}
                            <td>{{ umap_thresholds[i] }} æœªæº€</td>
                            {% elif i == 4 %}
                            <td>{{ umap_thresholds[i-1] }} ä»¥ä¸Š</td>
                            {% else %}
                            <td>{{ umap_thresholds[i-1] }}ï½{{ umap_thresholds[i] }}</td>
                            {% endif %}
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
                <p><span style="opacity:0.7;">â€» 5 ã«è¿‘ã„ã»ã©ã€ŒåŒã˜ã‚¯ãƒ©ã‚¹ã‚¿ã¯ã‚®ãƒ¥ãƒƒã¨å¯†é›†ã€åˆ¥ã‚¯ãƒ©ã‚¹ã‚¿ã¨ã¯ãƒãƒƒã‚­ãƒªé›¢ã‚Œã¦ã„ã‚‹ã€è‰¯ã„çŠ¶æ…‹ã§ã™ã€‚</span></p>

                <h4>3. ç”¨èªè§£èª¬</h4>
                <ul style="margin-left:1rem;">
                    <li><b>ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“</b> â€¦ å„æ„è¦‹ã‚’ â€œå˜èªã®ä½¿ã„æ–¹â€ ãªã©ã§æ•°ç™¾æ¬¡å…ƒã®åº§æ¨™ã«ç½®ã„ãŸ <q>è¦‹ãˆãªã„é«˜æ¬¡å…ƒåœ°å›³</q>ã€‚</li>
                    <li><b>UMAP</b> â€¦ ãã®é«˜æ¬¡å…ƒåœ°å›³ã‚’æŠ˜ã‚ŠãŸãŸã‚“ã§ 2 æ¬¡å…ƒã«æãç›´ã—ãŸ <q>è¦‹å–ã‚Šå›³</q>ã€‚æ•£å¸ƒå›³ã®åº§æ¨™ã§ã™ã€‚</li>
                </ul>
                <p style="margin-top:0.6rem;">
                    <b>æ´»ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š</b><br>
                    ãƒ»ã‚·ãƒ«ã‚¨ãƒƒãƒˆãŒä½ã„ã‚¯ãƒ©ã‚¹ã‚¿ â†’ ã¾ãšã¯ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’ç¢ºèªã—ã€<b>åˆ¥ã‚¯ãƒ©ã‚¹ã‚¿å€™è£œã®æ„è¦‹</b>ãŒæ··ã–ã£ã¦ã„ãªã„ã‹ç›®è¦–ãƒã‚§ãƒƒã‚¯ã€‚<br>
                    ãƒ»LLM ã‚¹ã‚³ã‚¢ãŒ 2 ä»¥ä¸‹ â†’ ãƒ©ãƒ™ãƒ«è¡¨ç¾ã‚„ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’å†æ•´ç†ã—ã€å¿…è¦ã«å¿œã˜ã¦ <b>ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ â†’ ãƒ¬ãƒãƒ¼ãƒˆå†ç”Ÿæˆ</b>ã€‚<br>
                    ãƒ»å…¨ä½“æ„Ÿã‚’ã¤ã‹ã‚€ç”¨é€” ãŒä¸»çœ¼ãªã®ã§ã€<u>å€‹ã€…ã®æ•°å€¤ã¯ â€œã–ã£ãã‚Šå‚¾å‘ã‚’çŸ¥ã‚‹ãŸã‚ã®æŒ‡æ¨™â€</u> ã¨ã„ã†ä½ç½®ä»˜ã‘ã§ã™ã€‚<br>
                </p>
            </div>
        </details>
    </div>
    <div class="chart-container" id="scatterChart"></div>

    <h2>æ„è¦‹ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§</h2>
    <button id="toggleAll" onclick="toggleAllGroups()">ã™ã¹ã¦å±•é–‹</button>
    <div id="groupContainer">
        {% macro render_group(group, parent_color='') %}
        {%- if group.level == 1 -%}
        {%- set my_color = color_map[group.id] -%}
        {%- else -%}
        {%- set my_color = parent_color -%}
        {%- endif -%}
        <div class="group" data-group-id="{{ group.id }}">
            <div class="group-header" onclick="toggleThisGroup(this)" style="color: {{ my_color }};">
                <span class="toggle">[+]</span>
                <span class="title">{{ group.label }}</span>
                {% set total = result.arguments | length %}
                {% set percentage = (group.value / total * 100) if total > 0 else 0 %}
                <span class="stats">{{ group.value }}ä»¶ ({{ "%.1f"|format(percentage) }}%)</span>
            </div>
            <div class="summary">{{ group.takeaway }}</div>

            <div class="evaluation" style="margin: 10px 0 10px 10px;">
                <div id="evaluationBlock" class="evaluation-block">
                    <table class="stat-table">
                        <tr>
                            <th>æ˜ç¢ºã•</th>
                            <th>ä¸€è²«æ€§</th>
                            <th>æ•´åˆæ€§</th>
                            <th>å·®ç•°æ€§</th>
                            <th>ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“</th>
                            <th>UMAP</th>
                        </tr>
                        <tr>
                            <td class="score-{{ group.scores.clarity.scaled | int  }}">{{ group.scores.clarity.scaled
                                }}</td>
                            <td class="score-{{ group.scores.coherence.scaled | int  }}">{{
                                group.scores.coherence.scaled }}</td>
                            <td class="score-{{ group.scores.consistency.scaled | int  }}">{{
                                group.scores.consistency.scaled
                                }}</td>
                            <td class="score-{{ group.scores.distinctiveness.scaled | int  }}">{{
                                group.scores.distinctiveness.scaled }}</td>
                            <td class="score-{{ group.scores.embedding.scaled | int  }}">{{
                                group.scores.embedding.scaled }}ï¼ˆ{{
                                "%.3f"|format(group.scores.embedding.raw) if group.scores.embedding.raw is number else
                                "N/A" }}ï¼‰</td>
                            <td class="score-{{ group.scores.umap.scaled | int  }}">{{ group.scores.umap.scaled }}ï¼ˆ{{
                                "%.3f"|format(group.scores.umap.raw) if group.scores.umap.raw is number else "N/A" }}ï¼‰
                            </td>
                        </tr>
                    </table>

                    <div class="evaluation" style="margin: 10px 0 10px 10px;">
                        <strong>è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆ:</strong> {{ group.llm.comment or "ï¼ˆãªã—ï¼‰" }}
                    </div>
                </div>
            </div>

            {% if group.level == 1 %}
            <div class="group-children" style="display: none;">
                {% for child in group.children %}
                {{ render_group(child, my_color) }}
                {% endfor %}
            </div>
            {% else %}
            {%- if group.children and group.children|length > 0 -%}
            <div class="group-children" style="display: none;">
                {% for child in group.children %}
                {{ render_group(child, my_color) }}
                {% endfor %}
            </div>
            {%- else -%}
            {% set group_args = result.arguments | selectattr("cluster_ids", "search", group.id) | list %}
            {% if group_args | length > 0 %}
            <div class="arguments" style="display: none;">
                <table class="stat-table">
                    <thead>
                        <tr>
                            <th style="width: 65%;">æ„è¦‹</th>
                            <th class="eval-column">ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“</th>
                            <th class="eval-column">UMAP</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for arg in group_args %}
                        <tr>
                            <td style="text-align: left;">{{ arg.argument }}</td>
                            <td class="eval-column score-{{ arg.silhouette.embedding.scaled }}">
                                {{ arg.silhouette.embedding.scaled }}ï¼ˆ{{ "%.3f"|format(arg.silhouette.embedding.raw) if
                                arg.silhouette.embedding.raw is number else "N/A" }}ï¼‰
                            </td>
                            <td class="eval-column score-{{ arg.silhouette.umap.scaled }}">
                                {{ arg.silhouette.umap.scaled }}ï¼ˆ{{ "%.3f"|format(arg.silhouette.umap.raw) if
                                arg.silhouette.umap.raw is number else "N/A" }}ï¼‰
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            {%- endif -%}
            {% endif %}
        </div>
        {% endmacro %}

        {% for group in cluster_tree %}
        {{ render_group(group) }}
        {% endfor %}
    </div>

    <script>
        function toggleThisGroup(headerElem) {
            const groupElem = headerElem.parentElement;
            const toggleElem = headerElem.querySelector(".toggle");
            const childContainer = groupElem.querySelector(".group-children") || groupElem.querySelector(".arguments");
            if (childContainer) {
                if (childContainer.style.display === "none") {
                    childContainer.style.display = "block";
                    toggleElem.textContent = "[-]";
                } else {
                    childContainer.style.display = "none";
                    toggleElem.textContent = "[+]";
                }
            }
        }

        function toggleAllGroups() {
            const btn = document.getElementById("toggleAll");
            const groups = document.querySelectorAll("#groupContainer .group");
            const expand = btn.textContent === "ã™ã¹ã¦å±•é–‹";
            groups.forEach(group => {
                const header = group.querySelector(".group-header");
                const toggleElem = header.querySelector(".toggle");
                const childContainer = group.querySelector(".group-children") || group.querySelector(".arguments");
                if (childContainer) {
                    childContainer.style.display = expand ? "block" : "none";
                    toggleElem.textContent = expand ? "[-]" : "[+]";
                }
            });
            btn.textContent = expand ? "ã™ã¹ã¦é–‰ã˜ã‚‹" : "ã™ã¹ã¦å±•é–‹";
        }

        const result = {{ result | tojson }};
        const color_map = {{ color_map | tojson }};

        const clusters = result.clusters.filter(c => c.level === 2);
        const args = result.arguments;

        const scatterData = clusters.map((cluster, idx) => {
            const clusterArgs = args.filter(arg => arg.cluster_ids.includes(cluster.id));
            const x = clusterArgs.map(arg => arg.x);
            const y = clusterArgs.map(arg => arg.y);

            let color = "";
            if (cluster.parent && color_map[cluster.parent]) {
                color = color_map[cluster.parent];
            } else {
                color = `hsl(${(idx * 40) % 360},70%,60%)`;
            }

            return {
                x: x,
                y: y,
                mode: "markers",
                type: "scatter",
                name: cluster.label,
                marker: { color: color, size: 7 },
                text: clusterArgs.map(arg => `<b>${cluster.label}</b><br>${arg.argument.replace(/(.{30})/g, "$1<br>")}`),
                hoverinfo: "text"
            };
        });

        const level1Clusters = result.clusters.filter(c => c.level === 1);
        const annotations = level1Clusters.map(cluster => {
            const clusterArgs = result.arguments.filter(arg => arg.cluster_ids.includes(cluster.id));
            if (clusterArgs.length > 0) {
                const sumX = clusterArgs.reduce((sum, arg) => sum + arg.x, 0);
                const sumY = clusterArgs.reduce((sum, arg) => sum + arg.y, 0);
                const centerX = sumX / clusterArgs.length;
                const centerY = sumY / clusterArgs.length;
                return {
                    x: centerX,
                    y: centerY,
                    xref: "x",
                    yref: "y",
                    text: cluster.label,
                    showarrow: false,
                    font: { color: "#fff", size: 14 },
                    bgcolor: color_map[cluster.id] || "#000",
                    opacity: 0.8
                };
            }
            return null;
        }).filter(ann => ann !== null);

        Plotly.newPlot("scatterChart", scatterData, {
            margin: { l: 20, r: 20, t: 20, b: 20 },
            xaxis: { showticklabels: false, zeroline: false },
            yaxis: { showticklabels: false, zeroline: false },
            hovermode: "closest",
            showlegend: false,
            annotations: annotations
        }, { responsive: true });
        function toggleEvaluation() {
            const blocks = document.querySelectorAll(".evaluation-block");
            const btn = document.getElementById("toggleEvalBtn");
            const evalCols = document.querySelectorAll(".eval-column");

            const currentlyHidden = Array.from(blocks).every(b => b.style.display === "none");

            blocks.forEach(b => {
                b.style.display = currentlyHidden ? "block" : "none";
            });

            evalCols.forEach(el => {
                el.style.display = currentlyHidden ? "table-cell" : "none";
            });

            btn.textContent = currentlyHidden ? "è©•ä¾¡ã‚’éš ã™" : "è©•ä¾¡ã‚’è¡¨ç¤º";
        }
    </script>
</body>

</html>